#include <stdio.h>
#include <ctype.h>
#include <string.h>
#include <stdlib.h>

#define MAX_PATH 1024

void writeAAVal(unsigned char val, FILE *fp)
{
	fputc(0xaa | (val >> 1), fp);
	fputc(0xaa | val, fp);
}

char *PathFindExtension(const char *path)
{
	char *p;

	for (p = (char *)path; *p != 0x00; p++);

	for (; *p != '.'; p--);

	return p;
}

void PathRemoveExtension(char *path)
{
	char *p;

	for (p = path; *p != 0x00; p++);

	for (; *p != '.'; p--);

	*p = 0x00;
}

void conv_nic2dsk(unsigned char *name)
{
	static unsigned char decTable[] = {
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x02, 0x03, 0x00, 0x04, 0x05, 0x06,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x07, 0x08, 0x00, 0x00, 0x00, 0x09, 0x0a, 0x0b, 0x0c, 0x0d,
		0x00, 0x00, 0x0e, 0x0f, 0x10, 0x11, 0x12, 0x13, 0x00, 0x14, 0x15, 0x16, 0x17, 0x18, 0x19, 0x1a,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x1b, 0x00, 0x1c, 0x1d, 0x1e,
		0x00, 0x00, 0x00, 0x1f, 0x00, 0x00, 0x20, 0x21, 0x00, 0x22, 0x23, 0x24, 0x25, 0x26, 0x27, 0x28,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x29, 0x2a, 0x2b, 0x00, 0x2c, 0x2d, 0x2e, 0x2f, 0x30, 0x31, 0x32,
		0x00, 0x00, 0x33, 0x34, 0x35, 0x36, 0x37, 0x38, 0x00, 0x39, 0x3a, 0x3b, 0x3c, 0x3d, 0x3e, 0x3f
	};

	static unsigned char scramble[] = {
		0, 7, 14, 6, 13, 5, 12, 4, 11, 3, 10, 2, 9, 1, 8, 15
	};
	static unsigned char FlipBit[4] = { 0, 2, 1, 3 };

	unsigned char src[512], dst[256 + 2];
	int volume = 0xfe;
	int track, sector;

	FILE *fp, *fpw;
	char path[MAX_PATH];

	if (!name || !name[0]) {
		return;
	}

	if (strncasecmp(PathFindExtension(name), ".NIC", 4) != 0) {
		fprintf(stderr, "Use .NIC file.");
		return;
	}

	fp = fopen(name, "r");
	if (fp == (FILE *)NULL) {
		fprintf(stderr, "Can't open the NIC file %s.", name);
		return;
	}

	strcpy(path, name);
	PathRemoveExtension(path);
	strcat(path, ".DSK");

	fpw = fopen(path, "w");
	if (fpw == (FILE *)NULL) {
		fprintf(stderr, "Can't write %s.\n", path);
		fclose(fp);
		return;
	}

	for (track = 0; track < 35; track++) {
		for (sector = 0; sector < 16; sector++) {
			int i, j;
			unsigned char x, ox = 0;

			if (fseek(fpw, track * (256 * 16) + scramble[sector] * 256, SEEK_SET) != 0) {
				fprintf(stderr, "File error.");
				fclose(fp);
				fclose(fpw);
				exit(-1);

			}
			fread(src, 1, 512, fp);
			for (j = 0, i = 0x38; i < 0x8e; i++, j++) {
				x = ((ox ^ decTable[src[i]]) & 0x3f);
				dst[j + 172] = FlipBit[(x >> 4) & 3];
				dst[j + 86] = FlipBit[(x >> 2) & 3];
				dst[j] = FlipBit[(x) & 3];
				ox = x;
			}
			for (j = 0, i = 0x8e; i < 0x18e; i++, j++) {
				x = ((ox ^ decTable[src[i]]) & 0x3f);
				dst[j] |= (x << 2);
				ox = x;
			}
			fwrite(dst, 1, 256, fpw);
		}
	}

	//fprintf(stderr, "the DSK file created."), TEXT("nic2dsk");
	fclose(fpw);
	fclose(fp);
}

int main(int argc, char *argv[])
{
	if (argc > 1) {
		int i;
		for (i = 1; i < argc; i++) {
			conv_nic2dsk(argv[i]);
		}
	}
	return 0;

}

